"use strict";var i=wx;function l(){return+new Date}var e=[],v={context:null},a={networkType:"",system:i.getSystemInfoSync()};function t(t){e.push({timestamp:l(),route:t})}function n(){e=[]}function r(){return e.slice()}function o(e){return function(t){return"Array"===e&&Array.isArray?Array.isArray(t):Object.prototype.toString.call(t)==="[object "+e+"]"}}var c=o("String"),s=o("Array"),m=o("Function"),y=o("Object"),u=o("Number");function f(t,e){return function(){if(m(e))try{e.apply(this,arguments)}catch(t){}if(m(t))return t.apply(this,arguments)}}function h(e,n,r){return function(){var t;if(m(n))try{n.apply(this,arguments)}catch(t){}if(m(e)&&(t=e.apply(this,arguments)),m(r))try{r.apply(this,arguments)}catch(t){}return t}}function p(t,e){if(y(t)&&m(t.handler)){var n=t.name,r=t.handler;e[n]=f(e[n],r),e[n]._ty_hook=!0}}var d=function(){function t(t){return t<0?NaN:t<=30?0|Math.random()*(1<<t):t<=53?(0|Math.random()*(1<<30))+(0|Math.random()*(1<<t-30))*(1<<30):NaN}function e(t,e){for(var n=t.toString(16),r=e-n.length,a="0";0<r;r>>>=1,a+=a)1&r&&(n=a+n);return n}return function(){return e(t(32),8)+"-"+e(t(16),4)+"-"+e(16384|t(12),4)+"-"+e(32768|t(14),4)+"-"+e(t(48),12)}}();function g(t){return t&&c(t)?JSON.parse(t):t}function x(t){try{return g(t)}catch(t){}return null}function b(t){var e="";try{e=JSON.stringify(t)}catch(t){e=""}return e}function q(t){return t+""}function T(t){return t?y(t)?b(t).length:c(t)?t.length:t instanceof ArrayBuffer?t.byteLength:t.length?t.length:0:0}var I="recordTyTime",A="TINGYUN_UID",S="custom",k="TRIGGER_LIFECYCLE",P="2.6.4",E=6e5,_=20,O="event",N="request",w="api",C="timer",R={},j=!1;function D(t){R=t||{}}function L(){return j}function M(t){j=t}var G={},U=[],F=0,H={},Y={uniqueId:0,requestId:0,apiId:0,otherActions:[],eventActions:[]},J={canSend:!1,sent:!1,apiRemain:0};function X(){G={},U=[],F=0,J.apiRemain=0,Y={uniqueId:0,requestId:0,apiId:0,otherActions:[],eventActions:[]}}function z(t){if(Y.eventActions||(Y.eventActions=[]),Y.otherActions||(Y.otherActions=[]),t)if(t.type===O){var e=R&&R.eventMaxSize||_;Y.eventActions&&Y.eventActions.length>=e&&Y.eventActions.shift(),Y.eventActions.push(t)}else Y.otherActions.push(t)}function B(){F=l()}var K=6e5,Q="TY_SAMPLING",V=i.getStorageSync(Q),W=!1;function Z(t){R.key&&R.beacon&&i.request({url:"".concat(R.beacon,"/mp-config/config/pullSampling?encodeMpId=").concat(R.key),method:"GET",_no_record:!0,success:function(t){var e=t.data||{},n=e.code,r=e.data;200===n&&r&&r.sampling&&u(r.sampling)&&(V=r.sampling,i.setStorageSync(Q,V))},complete:function(){t&&t(V)}})}function $(){V=V||(+R.sampleRate||1);var t=Math.random();W=t<=V}setInterval(Z,K);var tt={uid:et(),sid:d(),v:"1.3.5",at:"wx"};function et(){var t=i.getStorageSync(A);return t||(t=d(),i.setStorageSync(A,t)),t}function nt(t){if(W){var e=Object.assign({},tt,a||{},{key:R.key},t||{});e.launch=!t,i.request({url:"".concat(R.beacon,"/mp-app"),data:e,method:"POST",_no_record:!0,success:function(){}})}}function rt(t){if(W&&(k===t&&(J.canSend=!0),!J.sent&&J.canSend)){var e=Object.assign({},{path:H.current,pageEvent:Object.assign({},G),errs:U.slice(),fromPath:H.prev||"",actions:(Y.eventActions||[]).concat(Y.otherActions||[])},Object.assign({},tt,a||{},{key:R.key}),0<F?{ct:F}:{}),n=r();n&&(e.routeTrack=n),X(),J.sent=!0,J.canSend=!1,i.request({url:"".concat(R.beacon,"/mp-page"),data:e,method:"POST",_no_record:!0,success:function(){}})}}function at(t){$();var e=t.path,n=t.query,r=t.scene;a.openPath=e,R.disableFetchQuery||(a.query=n),a.scene=r,i.getNetworkType({success:function(t){a.networkType=t.networkType},complete:function(){nt()}})}function it(t){var e="",n="";if(c(t)?e=t:t&&(e=t.stack,n=t.message),e){var r={time:l(),stack:e};n&&(r.msg=n),U.push(r)}}function ot(){var t=r();n();var e=H.current;H.prev="",H.current="",nt({routeTrack:t,closePath:e})}function ct(t,e){t=t.split("."),e=e.split(".");for(var n=Math.max(t.length,e.length);t.length<n;)t.push("0");for(;e.length<n;)e.push("0");for(var r=0;r<n;r++){var a=parseInt(t[r]),i=parseInt(e[r]);if(i<a)return 1;if(a<i)return-1}return 0}function st(t,e){var n="";return t&&t.system&&(n=t.system.SDKVersion),n&&e?ct(n,e):-1}var ut=[{name:"onLaunch",handler:at},{name:"onError",handler:it},{name:"onHide",handler:ot}];function ft(e){return ut.forEach(function(t){p(t,e)}),e}function ht(t){return 0<=st(a,P)||!L()?t:ft.apply(this,arguments)}function pt(){var e=App;App=function(t){t=ft(t),e&&e.call(this,t)}}function dt(t){return R.ignoredPages&&s(R.ignoredPages)?R.ignoredPages.indexOf(t)<0:!R.pages||!s(R.pages)||-1<R.pages.indexOf(t)}function lt(){dt(this.route)&&(G.onLoad=l())}function vt(){dt(this.route)&&(G.onShow=l(),t(this.route),H.prev=H.current,H.current=this.route,J.sent=!1)}function mt(){dt(this.route)&&(G.onReady=l())}function yt(){dt(this.route)&&(G.onHide=l(),rt(k))}function gt(){dt(this.route)&&(G.onUnload=l(),rt(k))}var xt=[{name:"onLoad",handler:lt},{name:"onShow",handler:vt},{name:"onReady",handler:mt},{name:"onHide",handler:yt},{name:"onUnload",handler:gt}];function bt(t,e){for(var n in t)if(t.hasOwnProperty(n)&&m(t[n])&&!t[n]._ty_hook&&m(e)){var r=t[n];t[n]=e.call(this,n,r),t[n]._ty_hook=!0}}var qt=[N,w,C];function Tt(){var e={};return qt.forEach(function(t){e[t]={current:0,children:0}}),e}function It(t,e,n,r,a){this.id=++Y.uniqueId,this.parent=t||null,this.name=e||"<root>",this.type=n||"event",this.subType="event"===this.type?r||"tap":r,this.requests=[],this.apis=[],this.remain=Tt(),this.s=l(),this.e=null,this.data=a;var i=this,o=R&&R.eventTimeout||E;this.i=setTimeout(function(){i.timeout()},o),this.closed=!1,this.path=H.current,this.prevPath=H.prev}It.prototype.end=function(e,t){if(!this.closed){if(e)if(e.type===N||e.type===w){var n=e.requests||[],r=e.apis||[];this.requests.map(function(t){"".concat(t.url,"-").concat(t.requestId)===e.name&&(t.requests=n,t.apis=r)}),this.apis.map(function(t){"".concat(t.name,"-").concat(t.apiId)===e.name&&(t.requests=n,t.apis=r)})}else if(e.type===C){var a=e.requests||[],i=e.apis||[];this.requests=[].concat.call(this.requests||[],a),this.apis=[].concat.call(this.apis||[],i)}if(this.isNoRemain()||t)if(this.e=l(),this.closed=!0,this.i&&clearTimeout(this.i),this.parent)this.parent.end(this);else z(this.composeActionData()),v.context=null}},It.prototype.isNoRemain=function(t){var e=!0;for(var n in this.remain){if(this.remain.hasOwnProperty(n))if(!(this.remain[n].current<=0&&(!!t||this.remain[n].children<=0))){e=!1;break}}return e},It.prototype.timeout=function(){this.end(null,!0)},It.prototype.setData=function(t){this.data=t},It.prototype.hasPrevAssignedData=function(){return this.requests&&0<this.requests.length||this.apis&&0<this.apis.length},It.prototype.composeActionData=function(){var t={id:this.id,name:this.name,type:this.type,start:this.s,end:this.e,duration:0<this.e-this.s?this.e-this.s:0,requests:(this.requests||[]).slice(),apis:(this.apis||[]).slice(),data:this.data||{},path:this.path,prevPath:this.prevPath};return this.type!==N&&this.type!==w||delete(t=Object.assign({},t,this.data)).data,t},It.prototype.canEnd=function(t,e){return this.isNoRemain(!0)},It.prototype.isEventChildContext=function(){for(var t=this.parent,e=!1;null!=t;){if("event"===t.type){e=!0;break}t=t.parent}return e},It.prototype.updateRemain=function(t,e){e=e||N;var n=t||0;this.remain[e].current=this.remain[e].current+n;for(var r=this.parent;r;)r.remain[e].children=r.remain[e].children+n,r=r.parent},Object.defineProperty(It.prototype,"current",{get:function(){return v.context},enumerable:!0,configurable:!0}),Object.defineProperty(It,"createEvent",{value:function(t,e,n,r,a){return new It(t,e,n||"event",r||null,a)},enumerable:!0,configurable:!0,writable:!0});var At="tyname";function St(t){return!t||"tap"!==t.type||!y(t.target)||!y(t.currentTarget)||null==t.timeStamp}function kt(t,e){var n,r=t.target||{},a=r.offsetLeft,i=r.offsetTop,o=r.id,c=r.dataset,s=t.detail||{},u=s.x,f=s.y;t._relatedInfo&&(n=t._relatedInfo.anchorTargetText);var h={target:{offsetLeft:a,offsetTop:i,id:o,x:u,y:f},dataset:{name:c[At],targetName:n,methodName:e}},p=e||"";v.context=It.createEvent(null,p,"event",t.type,h)}function Pt(){v.context&&v.context.canEnd()&&v.context.end()}function Et(r,a){return function(){var t,e=arguments[0]||{},n=St(e);if(!n)try{kt.call(this,e,r)}catch(t){}try{t=a.apply(this,arguments)}finally{if(!n)try{Pt.call(this)}catch(t){}}return t}}function _t(n){var r=v.context;return function(){var t,e=v.context;v.context=r;try{t=n.apply(this,arguments)}finally{e&&!e.closed&&(v.context=e)}return t}}function Ot(t){return _t(t)}function Nt(e){return xt.forEach(function(t){p(t,e)}),bt(e,Et),e[I]=B,e}function wt(t){return 0<=st(a,P)||!L()?t:Nt.apply(this,arguments)}function Ct(){var e=Page;Page=function(t){t=Nt(t),e&&e.call(this,t)}}var Rt=i.request;function jt(t,e){if(t){var n=x(t["X-Tingyun-Tx-Data"]);if(n&&n.r&&q(n.r)===q(e))return n}return null}function Dt(t){if(!t)return 0;var e=t.header,n=t.data,r=0;return(r=+(e&&e["Content-Length"]))&&u(r)&&!Number.isNaN(r)||(r=T(n)||0),r}function Lt(t,e){var n={},r=jt(t.header,e.r);return r&&(n.s_id=r.id,n.s_name=r.action,r.time&&(n.s_du=r.time.duration,n.s_qu=r.time.qu),n.t_id=r.trId),n}function Mt(t,e,n){return{requestId:t.requestId,type:N,url:t.url,method:t.method,start:t.start,end:t.end,cbTime:t.cbTime,duration:0<t.end-t.start?t.end-t.start:0,send:T(e.data),rec:Dt(n),statusCode:n.statusCode||0}}function Gt(t,e){if(!t.context){var n="".concat(t.url,"-").concat(t.requestId);t.context=It.createEvent(e,n,N)}v.context=t.context}function Ut(t,e,n){v.context&&v.context.setData(n);var r=v.context&&v.context.hasPrevAssignedData(),a=v.context&&v.context.canEnd();a&&v.context.end(),e&&e.id===t.cid&&n&&(e.requests.push(n),e.updateRemain(-1,N),e.canEnd()&&a&&e.end(r?v.context:null))}var Ft=function(t){var f=t||{};if(!f._no_record&&f.url&&L()){var h=v.context,p={requestId:++Y.requestId,url:f.url,method:f.method&&f.method.toUpperCase()||"GET",callbackContextCreated:!1,cbTime:0};p.r=l()%1e9,f.header=f.header||{},f.header["X-Tingyun-Id"]="".concat(R.id,";r=").concat(p.r);var r=f.success,a=f.fail,d=f.complete;f.success=Ot(function(){var t;if(p.end||(p.end=l()),Gt(p,h),r){var e=l();try{t=r.apply(this,arguments)}finally{var n=l()-e;0<n&&(p.cbTime+=n)}}return t}),f.fail=Ot(function(){var t;if(p.end||(p.end=l()),Gt(p,h),a){var e=l();try{t=a.apply(this,arguments)}finally{var n=l()-e;0<n&&(p.cbTime+=n)}}return t}),f.complete=Ot(function(t){var e,n;p.end||(p.end=l());var r=R[S];if(r&&m(r))try{var a=r.apply(this,arguments);y(a)&&(n={custom:a})}catch(t){}if(Gt(p,h),d){var i=l();try{e=d.apply(this,arguments)}finally{var o=l()-i;0<o&&(p.cbTime+=o)}}var c=Lt(t,p),s=Mt(p,f,t),u=Object.assign({},s,c||{},n||{});return Ut(p,h,u),e}),p.start=l(),h&&(p.cid=h.id,h.updateRemain(1))}return Rt.apply(this,arguments)};function Ht(){Object.defineProperty(i,"request",{configurable:!0,enumerable:!0,writable:!0,value:Ft})}function Yt(e){return e.methods||(e.methods={}),xt.forEach(function(t){p(t,e.methods)}),e}function Jt(t){return 0<=st(a,P)||!L()?t:Yt.apply(this,arguments)}function Xt(){var e=Component;Component=function(t){t=Yt(t),e&&e.call(this,t)}}function zt(t,e){a.uid=t,i.setStorageSync(A,t)}function Bt(){return v.context}var Kt,Qt={version:"1.3.5",setUser:zt,hookApp:ht,hookPage:wt,hookComponent:Jt,request:Ft,getContext:Bt},Vt=["success","fail"],Wt=[],Zt={requestPayment:{fail:function(t){var e=arguments&&t,n="fail";return e&&y(e)&&"requestPayment:fail cancel"===e.errMsg&&(n="cancel"),n}}};function $t(){(Kt=R.hookApis||["requestPayment","scanCode","previewImage"]).forEach(function(t){-1<Wt.indexOf(t)||"request"===t||Wt.push(t)})}function te(t){return{apiId:t.apiId,type:w,name:t.name,success:t.success||0,fail:t.fail||0,cancel:t.cancel||0,start:t.start,end:t.end,duration:0<t.end-t.start?t.end-t.start:0,count:1}}function ee(t,e){if(!t.context){var n="".concat(t.name,"-").concat(t.apiId);t.context=It.createEvent(e,n,w)}v.context=t.context}function ne(t,e,n){v.context&&v.context.setData(n);var r=v.context&&v.context.hasPrevAssignedData(),a=v.context&&v.context.canEnd();a&&v.context.end(),e&&e.id===t.cid&&n&&(e.apis.push(n),e.updateRemain(-1,w),e.canEnd()&&a&&e.end(r?v.context:null))}function re(a){var e=i[a];return function(){var n=v.context,t=arguments[0]||{},r={apiId:++Y.apiId,name:a};return Vt.forEach(function(e){t[e]=Ot(f(t[e],function(){var t;r.end||(r.end=l()),ee(r,n),(t=Zt[a]&&Zt[a][e]&&m(Zt[a][e])?Zt[a][e].apply(this,arguments):r[e]=1)&&(r[t]=1)}))}),t.complete=Ot(h(t.complete,function(){r.end||(r.end=l()),ee(r,n)},function(){var t=te(r);ne(r,n,t)})),n&&(r.cid=n.id,n.updateRemain(1,w)),r.start=l(),e.apply(this,arguments)}}function ae(t){t&&i[t]&&Object.defineProperty(i,t,{configurable:!0,enumerable:!0,writable:!0,value:re(t)})}function ie(){Kt||$t();var e={};return Wt.forEach(function(t){e[t]=re(t)}),e}function oe(){Kt||$t(),Wt.forEach(function(t){ae(t)})}function ce(t){(!t||0<=st(a,P))&&(pt(),Ct(),Ht(),Xt(),oe()),t&&Object.assign(Qt,ie()||{})}function se(t){if(!L()){D(t||{}),M(!0),Z();var e=!0;null!=R.plugin&&(e=R.plugin),ce(e)}}function ue(){return Qt.config=se,Qt}i.onNetworkStatusChange(function(t){a.networkType=t.networkType});var fe=ue();module.exports=fe;